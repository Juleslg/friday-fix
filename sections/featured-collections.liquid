{%- if section.blocks.size > 0 -%}
  <style>
    #shopify-section-{{ section.id }} {
      --product-list-column-count: {{ section.settings.products_per_row_mobile | times: 1 }};
    }
  
    @media screen and (min-width: 700px) {
      #shopify-section-{{ section.id }} {
        --product-list-column-count: 2;
      }
    }
  
    @media screen and (min-width: 1000px) {
      #shopify-section-{{ section.id }} {
        --product-list-column-count: {{ section.settings.products_per_row_desktop }};
      }
    }

    {%- if section.settings.layout_style == 'compact_grid' -%}
      /* Compact 2-row carousel */
      #shopify-section-{{ section.id }} .product-list--compact-2row {
        display: grid !important;
        grid-template-rows: repeat(2, auto);
        grid-auto-flow: column;
        grid-auto-columns: 45%;
        gap: 0.5rem;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        padding: 0 var(--container-gutter);
        margin: 0 calc(-1 * var(--container-gutter));
      }
      
      #shopify-section-{{ section.id }} .product-list--compact-2row::-webkit-scrollbar {
        display: none;
      }
      
      #shopify-section-{{ section.id }} .product-list--compact-2row {
        scrollbar-width: none;
      }
      
      #shopify-section-{{ section.id }} .product-list--compact-2row > * {
        scroll-snap-align: start;
        min-width: 0;
      }
      
      /* Force equal height for all cards */
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card {
        height: 100%;
      }
      
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__figure {
        height: 100%;
      }
      
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__media {
        height: 100%;
      }
      
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__image {
        height: 100%;
        width: 100%;
        object-fit: cover;
      }

      /* Hide product info in compact mode */
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__info,
      #shopify-section-{{ section.id }} .product-list--compact-2row .badge-list,
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__quick-buy,
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__floating-size-selector,
      #shopify-section-{{ section.id }} .product-list--compact-2row .product-card__swatch-list {
        display: none !important;
      }
      
      @media screen and (min-width: 700px) {
        #shopify-section-{{ section.id }} .product-list--compact-2row {
          grid-auto-columns: 30%;
          gap: 0.75rem;
        }
      }
      
      @media screen and (min-width: 1000px) {
        #shopify-section-{{ section.id }} .product-list--compact-2row {
          grid-auto-columns: 16%;
          gap: 0.75rem;
        }
      }
      
      @media screen and (min-width: 1400px) {
        #shopify-section-{{ section.id }} .product-list--compact-2row {
          grid-auto-columns: 14%;
        }
      }
    {%- endif -%}
  </style>

  <div class="color-scheme color-scheme--{{ section.settings.color_scheme.id }}">
    <div class="container section-spacing">
      {%- liquid
        assign has_at_least_one_description = false

        for block in section.blocks
          if block.settings.content != blank
            assign has_at_least_one_description = true
            break
          endif
        endfor
      -%}

      <div class="v-stack {% if has_at_least_one_description %}gap-4{% else %}gap-8 sm:gap-10{% endif %}">
        {%- if section.settings.show_title -%}
          <div class="featured-collections-header">
            <featured-collections-tabs role="tablist" class="featured-collections-header__tab-list {% if section.settings.tabs_alignment == 'center' %}justify-center{% endif %} scroll-area bleed">
              <template shadowrootmode="open">
                <slot part="tab-list" name="tab"></slot>
              </template>

              {%- for block in section.blocks -%}
                {%- capture tab_title -%}
                  {%- if section.settings.tabs_icon == 'arrow' -%}
                    {%- render 'icon' with 'big-arrow-right', stroke_width: 3, direction_aware: true -%}
                  {%- endif -%}

                  <span {% if section.blocks.size == 1 and section.settings.tabs_alignment == 'center' %}class="text-center"{% endif %}>{{- block.settings.title | default: block.settings.collection.title | default: 'Collection' -}}</span>
                {%- endcapture -%}

                {%- if section.blocks.size > 1-%}
                  <button class="{% if section.settings.tabs_icon != 'none' %}text-indent text-indent--{{ section.settings.tabs_icon }}{% endif %} h4 sm:h3" role="tab" slot="tab" aria-controls="collection-{{ block.id }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}" {{ block.shopify_attributes }}>
                    {{- tab_title -}}
                  </button>
                {%- else -%}
                  <div class="{% if section.settings.tabs_icon != 'none' %}text-indent text-indent--{{ section.settings.tabs_icon }}{% endif %} h4 sm:h3" role="tab" slot="tab" aria-selected="true" {{ block.shopify_attributes }}>
                    {{- tab_title -}}
                  </div>
                {%- endif -%}
              {%- endfor -%}
            </featured-collections-tabs>

            {%- if section.settings.show_view_all_button and has_at_least_one_description == false and section.settings.tabs_alignment != 'center' -%}
              {%- assign view_all_button = 'sections.featured_collections.view_all' | t -%}
              {%- render 'button', content: view_all_button, href: section.blocks.first.settings.link, style: 'outline', class: 'md-max:hidden' -%}
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- liquid
          assign product_list_class = ''
          assign is_compact_mode = false
          
          if section.settings.layout_style == 'compact_grid'
            assign is_compact_mode = true
            assign product_list_class = 'product-list--compact-2row'
          elsif section.settings.stack_products_mobile == false and section.settings.stack_products_desktop == false
            assign product_list_class = 'product-list--carousel scroll-area'
          elsif section.settings.stack_products_mobile == false
            assign product_list_class = 'sm-max:product-list--carousel scroll-area'
          elsif section.settings.stack_products_desktop == false
            assign product_list_class = 'sm:product-list--carousel scroll-area'
          endif
        -%}

        <div class="featured-collections-products">
          {%- for block in section.blocks -%}
            <div id="collection-{{ block.id }}" data-url="{{ block.settings.link | escape }}" class="v-stack {% if section.settings.tabs_alignment == 'center' %}justify-items-center{% endif %} gap-8 sm:gap-12" {% unless forloop.first %}hidden{% endunless %}>
              {%- liquid
                assign show_content = false  

                if section.settings.tabs_alignment == 'center' and block.settings.content != blank
                  assign show_content = true
                elsif section.settings.tabs_alignment == 'start' and has_at_least_one_description
                  assign show_content = true
                endif
              -%}

              {%- if show_content or section.settings.show_view_all_button -%}
                {%- assign view_all_button = 'sections.featured_collections.view_all' | t -%}

                {%- if section.settings.tabs_alignment == 'center' -%}
                  <div class="prose prose-justify-center max-w-md">
                    {{- block.settings.content -}}

                    {%- if section.settings.show_view_all_button -%}
                      {%- render 'button', content: view_all_button, href: block.settings.link, style: 'outline' -%}
                    {%- endif -%}
                  </div>
                {%- else -%}
                  <div class="h-stack wrap gap-6 justify-between">
                    {%- assign button_class = 'md:hidden' -%}

                    {%- if has_at_least_one_description -%}
                      {%- assign button_class = '' -%}
                    {%- endif -%}

                    {%- if block.settings.content != blank -%}
                      <div class="prose max-w-md">
                        {{- block.settings.content -}}
                      </div>
                    {%- endif -%}

                    {%- if section.settings.show_view_all_button -%}
                      {%- render 'button', content: view_all_button, href: block.settings.link, style: 'outline', class: button_class -%}
                    {%- endif -%}
                  </div>
                {%- endif -%}
              {%- endif -%}

              {%- assign product_list_id = 'product-list-' | append: block.id -%}

              {%- liquid
                if is_compact_mode
                  assign show_carousel_controls = true
                else
                  unless section.settings.stack_products_desktop
                    assign show_carousel_controls = true
                  else
                    assign show_carousel_controls = false
                  endunless
                endif
              -%}

              <div class="w-full {% if show_carousel_controls %}floating-controls-container{% endif %}">
                {%- if show_carousel_controls -%}
                  <carousel-prev-button class="floating-controls__control" aria-controls="{{ product_list_id }}">
                    <button class="circle-button circle-button--xl" disabled>
                      <span class="sr-only">{{ 'general.accessibility.previous' | t }}</span>
                      {%- render 'icon' with 'big-arrow-left', direction_aware: true, width: 14 -%}
                    </button>
                  </carousel-prev-button>
                {%- endif -%}

                {%- liquid
                  if is_compact_mode
                    assign products_to_show = block.settings.products_count
                    assign image_sizes = '(max-width: 699px) 45vw, (max-width: 999px) 30vw, 16vw'
                  else
                    assign products_to_show = block.settings.products_count
                    capture image_sizes
                      echo '(max-width: 699px) calc(100vw / '
                      echo section.settings.products_per_row_mobile
                      echo ' - 40px), (max-width: 999px) calc(100vw / '
                      echo 3 | at_most: section.settings.products_per_row_desktop
                      echo ' - 64px), calc((100vw - 96px) / '
                      echo section.settings.products_per_row_desktop
                      echo ')'
                    endcapture
                  endif
                -%}

                <product-list id="{{ product_list_id }}" class="product-list {% unless is_compact_mode %}product-list--padded full-bleed{% endunless %} {% if section.settings.tabs_alignment == 'center' and is_compact_mode == false %}justify-center{% endif %} {{ product_list_class }}">
                  {%- liquid
                    if block.settings.collection != blank
                      paginate block.settings.collection.products by products_to_show
                        for product in block.settings.collection.products limit: products_to_show
                          render 'product-card', product: product, reveal: true, sizes: image_sizes, position: forloop.index, block: block
                        endfor
                      endpaginate
                    else
                      for i in (1..products_to_show)
                        render 'product-card-placeholder', loop_index: i
                      endfor
                    endif
                  -%}
                </product-list>

                {%- if show_carousel_controls -%}
                  <carousel-next-button class="floating-controls__control" aria-controls="{{ product_list_id }}">
                    <button class="circle-button circle-button--xl">
                      <span class="sr-only">{{ 'general.accessibility.next' | t }}</span>
                      {%- render 'icon' with 'big-arrow-right', direction_aware: true, width: 14 -%}
                    </button>
                  </carousel-next-button>
                {%- endif -%}
              </div>

              {%- if section.settings.show_scrolling_bar -%}
                {%- liquid
                  assign show_progress_bar = false
                  assign progress_bar_class = ''

                  if is_compact_mode
                    assign show_progress_bar = true
                  elsif section.settings.stack_products_desktop == false or section.settings.stack_products_mobile == false
                    assign show_progress_bar = true
                    if section.settings.stack_products_desktop == false and section.settings.stack_products_mobile
                      assign progress_bar_class = 'sm-max:hidden'
                    elsif section.settings.stack_products_mobile == false and section.settings.stack_products_desktop
                      assign progress_bar_class = 'sm:hidden'
                    endif
                  endif
                -%}

                {%- if show_progress_bar -%}
                  <progress-bar track-scroll-target="{{ product_list_id }}" class="progress-bar progress-bar--limit-width {{ progress_bar_class }}"></progress-bar>
                {%- endif -%}
              {%- endif -%}
            </div>
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "t:sections.featured_collections.name",
  "class": "shopify-section--featured-collections",
  "max_blocks": 4,
  "tag": "section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:global.colors.scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "layout_style",
      "label": "Layout style",
      "options": [
        {
          "value": "standard",
          "label": "Standard"
        },
        {
          "value": "compact_grid",
          "label": "Compact 2-row carousel"
        }
      ],
      "default": "standard"
    },
    {
      "type": "checkbox",
      "id": "stack_products_mobile",
      "label": "t:global.product_list.stack_products_mobile",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "stack_products_desktop",
      "label": "t:global.product_list.stack_products_desktop",
      "default": true
    },
    {
      "type": "select",
      "id": "products_per_row_mobile",
      "label": "t:global.product_list.products_per_row_mobile",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ],
      "default": "2"
    },
    {
      "type": "range",
      "id": "products_per_row_desktop",
      "min": 2,
      "max": 5,
      "label": "t:global.product_list.products_per_row_desktop",
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "t:sections.featured_collections.show_title",
      "default": true
    },
    {
      "type": "select",
      "id": "tabs_alignment",
      "label": "t:sections.featured_collections.tabs_alignment",
      "options": [
        {
          "value": "start",
          "label": "t:global.position.left"
        },
        {
          "value": "center",
          "label": "t:global.position.center"
        }
      ],
      "default": "start"
    },
    {
      "type": "select",
      "id": "tabs_icon",
      "label": "t:sections.featured_collections.tabs_icon",
      "options": [
        {
          "value": "none",
          "label": "t:sections.featured_collections.tabs_icon_options.none"
        },
        {
          "value": "arrow",
          "label": "t:sections.featured_collections.tabs_icon_options.arrow"
        },
        {
          "value": "circle",
          "label": "t:sections.featured_collections.tabs_icon_options.circle"
        },
        {
          "value": "square",
          "label": "t:sections.featured_collections.tabs_icon_options.square"
        },
        {
          "value": "diamond",
          "label": "t:sections.featured_collections.tabs_icon_options.diamond"
        }
      ],
      "default": "arrow"
    },
    {
      "type": "checkbox",
      "id": "show_view_all_button",
      "label": "t:sections.featured_collections.show_view_all_button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_scrolling_bar",
      "label": "t:global.product_list.show_scrolling_bar",
      "info": "t:global.product_list.show_scrolling_bar_info",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "t:sections.featured_collections.blocks.collection.name",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "t:sections.featured_collections.blocks.collection.collection"
        },
        {
          "type": "range",
          "id": "products_count",
          "min": 2,
          "max": 50,
          "label": "t:global.product_list.products_to_show",
          "default": 8
        },
        {
          "type": "text",
          "id": "title",
          "label": "t:global.text.title",
          "default": "{{ block.settings.collection.title }}"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "t:global.text.content",
          "default": "<p>{{ block.settings.collection.description }}</p>"
        },
        {
          "type": "url",
          "id": "link",
          "label": "t:global.text.link_url",
          "default": "{{ block.settings.collection.url }}"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.featured_collections.name",
      "category": "t:global.categories.collections",
      "blocks": [
        {
          "type": "collection"
        }
      ]
    }
  ]
}
{% endschema %}
