<!doctype html>

<html lang="{{ request.locale.iso_code }}" dir="{% render 'direction' %}">
  <head>
    <script src="{{ 'pandectes-rules.js' | file_url }}"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=5.0">

    <title>{% if page_title == blank %}{{ shop.name }}{% else %}{{ page_title }}{% if current_page != 1 %} &ndash; {{ 'general.page' | t: page: current_page }}{% endif %}{% endif %}</title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 96 }}">
      <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180 }}">
    {%- endif -%}

    <!-- Google Site Verification Tags -->
    <meta name="google-site-verification" content="oEMlnmnci8Xs_QCDb_9ek-VJdmYea0LTazpeQxr3-gM">
    <meta name="google-site-verification" content="B-n71eUGwaxMr9h0QYQ_J5wPUhc1S8B8KxqIPVZwNgc">

    {%- unless settings.heading_font.system? -%}
      <link rel="preload" href="{{ settings.heading_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- unless settings.text_font.system? -%}
      <link rel="preload" href="{{ settings.text_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- render 'social-meta-tags' -%}
    {%- render 'microdata-schema' -%}
    {%- render 'css-variables' -%}
    {%- render 'js-variables' -%}

    {%- if request.page_type == 'gift_card' -%}
      <script src="{{ 'vendor/qrcode.js' | shopify_asset_url }}" defer></script>
    {%- endif -%}

    <script type="importmap">
      {%- comment -%}On Safari 16.3 and lower, a polyfill is used to load importmap{%- endcomment -%}
      {
        "imports": {
          "vendor": "{{ 'vendor.min.js' | asset_url }}",
          "theme": "{{ 'theme.js' | asset_url }}",
          "photoswipe": "{{ 'photoswipe.min.js' | asset_url }}"
        }
      }
    </script>

    <script type="module" src="{{ 'vendor.min.js' | asset_url }}"></script>
    <script type="module" src="{{ 'theme.js' | asset_url }}"></script>
    <script src="{{ 'custom-badge-colors.js' | asset_url }}" defer></script>
    <script src="{{ 'product-gallery-click.js' | asset_url }}" defer></script>

    {{ content_for_header }}

    {{- 'theme.css' | asset_url | stylesheet_tag: preload: true -}}
    
    <!-- Klaviyo Tracking Script -->
    <script async type='text/javascript' src='https://static.klaviyo.com/onsite/js/klaviyo.js?company_id=VbiARM'></script>
        <link rel="stylesheet" href="{{ 'swish-buttons.css' | asset_url }}" />
  </head>

  {% liquid
    assign features_class = ''

    if settings.image_hover_animation == 'zoom'
      assign features_class = features_class | append: 'features--zoom-image '
    elsif settings.image_hover_animation == 'zoom_filter'
      assign features_class = features_class | append: 'features--zoom-filter-image '
    endif
  %}

  <body class="{{ features_class }}">
    {%- render 'shadow-dom-templates' -%}

    <loading-bar class="loading-bar" aria-hidden="true"></loading-bar>

    <a href="#main" allow-hash-change class="skip-to-content sr-only">{{ 'general.accessibility.skip_to_content' | t }}</a>

    <span id="header-scroll-tracker" style="position: absolute; width: 1px; height: 1px; top: 200px; left: 0;">
      {%- comment -%}
        This allows our theme to track when the user has scrolled a given amount of pixels, without relying on a global scroll listener. This helps
        to improve performance and reduce reflows.
      {%- endcomment -%}
    </span>
    
    {%- if request.page_type != 'password' -%}
      {%- sections 'header-group' -%}
      {%- sections 'overlay-group' -%}
    {%- endif -%}

    <main id="main" class="anchor">
      {{ content_for_layout }}
    </main>

    {%- if request.page_type != 'password' -%}
      {%- sections 'footer-group' -%}
    {%- endif -%}

    <x-toast class="toast">
      {% comment %}Container for notification messages; DO NOT DELETE{% endcomment %}
    </x-toast>

    <script>
      // Initialize Google Tag Manager dataLayer
      window.dataLayer = window.dataLayer || [];

      // Klaviyo Form Tracking with Google Analytics
      window.addEventListener("klaviyoForms", function(e) { 
        if (e.detail.type == 'open' || e.detail.type == 'embedOpen') {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_open', {'form': 'Klaviyo form', 'form_id': e.detail.formId});
          }
          console.log('Klaviyo form opened:', e.detail.formId);
        }
        if (e.detail.type == 'submit') {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_submit', {'form': 'Klaviyo form', 'form_id': e.detail.formId});
          }
          console.log('Klaviyo form submitted:', e.detail.formId);
        }
        if (e.detail.type == 'stepSubmit') {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_step_submit', {'form': 'Klaviyo form', 'step_name': e.detail.metaData.$step_name});
          }
          console.log('Klaviyo form step submitted:', e.detail.metaData.$step_name);
        }
        if (e.detail.type == 'redirectedToUrl') {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_url_redirect', {'form': 'Klaviyo form', 'form_id': e.detail.formId});
          }
          console.log('Klaviyo form redirected:', e.detail.formId);
        }
        if (e.detail.type == 'close') {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_close', {'form': 'Klaviyo form', 'form_id': e.detail.formId});
          }
          console.log('Klaviyo form closed:', e.detail.formId);
        }
      });

      // Sign-up Event Tracking
      if (window.location.href.includes("?syclid=")) {
        // Shopify Analytics
        Shopify.analytics.publish("sign_up", {});
        
        // Google Analytics via dataLayer
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          'event': 'sign_up',
        });

        // Clean URL after tracking
        const currentUrl = new URL(window.location.href);
        currentUrl.search = '';
        window.history.replaceState({}, document.title, currentUrl.href);
      }

      // Click Event Tracking
      window.addEventListener("click", function(event) {
        // Shopify Analytics
        Shopify.analytics.publish("custom_click", {
          targetLink: event.target.href,
          targetId: event.target.id || null, 
          targetText: event.target.innerText || null
        });
      });

      // Cookie Consent Event Tracking
      window.addEventListener('cookie_consent_set', event => {
        console.log(event.detail)
        Shopify.analytics.publish("cf_after_consent_update", event.detail);
      });
    </script>
  </body>
</html>